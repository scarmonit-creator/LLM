<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mail.tm API Demo: Send Message</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 1rem;
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 4px;
        max-height: 80vh;
        overflow: auto;
      }
      label {
        display: block;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <h1>Mail.tm API Demo: Send a Message</h1>
    <p>This page obtains a JWT token for the configured account and sends a test email to the same mailbox. Fill in the details below and click "Send".</p>
    <form id="msgForm">
      <label>
        To (mail.tm address):
        <input type="email" id="to" value="assistant737396@tiffincrane.com" size="40" />
      </label>
      <label>
        Subject:
        <input type="text" id="subject" value="Test message" size="60" />
      </label>
      <label>
        Text:
        <textarea id="text" rows="4" cols="60">Hello from the multi-agent system!</textarea>
      </label>
      <button type="submit">Send Message</button>
    </form>
    <pre id="status">Waiting...</pre>
    <script>
      (function () {
        const form = document.getElementById('msgForm');
        const statusEl = document.getElementById('status');
        const credentials = {
          address: 'assistant737396@tiffincrane.com',
          password: 'AssistantDemo123!'
        };
        form.addEventListener('submit', async (evt) => {
          evt.preventDefault();
          statusEl.textContent = 'Obtaining token...';
          // Fetch token
          const tokenRes = await fetch('https://api.mail.tm/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(credentials)
          });
          const tokenJson = await tokenRes.json();
          if (!tokenRes.ok || !tokenJson.token) {
            statusEl.textContent = `Failed to get token: ${tokenRes.status} ${tokenRes.statusText}\n${JSON.stringify(tokenJson)}`;
            return;
          }
          statusEl.textContent = 'Sending message...';
          const to = document.getElementById('to').value;
          const subject = document.getElementById('subject').value;
          const text = document.getElementById('text').value;
          const msgBody = { to: [to], subject, text };
          const sendRes = await fetch('https://api.mail.tm/messages', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${tokenJson.token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(msgBody)
          });
          const sendJson = await sendRes.json();
          statusEl.textContent = `Send status: ${sendRes.status}\nResponse: ${JSON.stringify(sendJson, null, 2)}`;
        });
      })();
    </script>
  </body>
</html>