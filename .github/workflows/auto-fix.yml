name: Auto-Fix CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Prevent concurrent workflow runs to avoid conflicts
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      fail-fast: false
      matrix:
        # Use single LTS version for auto-fix to avoid redundant runs
        node-version: [20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci --prefer-offline --no-audit
        npm install -g eslint@latest
      continue-on-error: false
    
    - name: Run ESLint and auto-fix
      id: eslint
      run: |
        npx eslint . --fix --ext .js,.jsx,.ts,.tsx || true
      continue-on-error: true
    
    - name: Run Prettier
      id: prettier
      run: |
        npx prettier --write "**/*.{js,jsx,ts,tsx,json,css,md}" || true
      continue-on-error: true
    
    - name: Verify changed files
      id: verify-changed-files
      run: |
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No files were changed by auto-fix"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Files were changed by auto-fix:"
          git diff --name-only
        fi

    - name: Create Pull Request with fixes
      if: steps.verify-changed-files.outputs.changed == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'Auto-fix: Apply automated fixes [skip ci]'
        title: 'Auto-fix: Apply automated fixes'
        body: |
          This PR contains automated fixes from ESLint and Prettier.
          
          Changes were triggered by push to main branch.
          
          Please review the changes and merge if appropriate.
        branch: auto-fix-${{ github.run_id }}
        delete-branch: true
        base: main

    - name: Commit and push changes for non-main branches
      if: steps.verify-changed-files.outputs.changed == 'true' && github.event_name == 'push' && github.ref != 'refs/heads/main'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "Auto-fix: Apply automated fixes [skip ci]"
        git push
    
    - name: Run tests
      run: npm test
      continue-on-error: true
    
    - name: Summary
      if: always()
      run: |
        echo "### Auto-Fix Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
          echo "✅ Changes were made and committed" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ No changes were needed" >> $GITHUB_STEP_SUMMARY
        fi
