name: Automated Optimization

on:
  push:
    branches: [ main, develop, optimize-* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run optimization checks daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      optimization_level:
        description: 'Optimization Level'
        required: true
        default: 'full'
        type: choice
        options:
        - basic
        - full
        - aggressive

jobs:
  optimize:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        npm install -g depcheck
    
    - name: Cache optimization results
      uses: actions/cache@v3
      with:
        path: |
          node_modules/.cache
          .eslintcache
          dist/
        key: optimization-${{ runner.os }}-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          optimization-${{ runner.os }}-${{ matrix.node-version }}-
    
    - name: Run code analysis
      run: |
        npm run lint:check
        npm run format:check
        npm run typecheck
    
    - name: Run basic optimization
      if: ${{ github.event.inputs.optimization_level != 'aggressive' }}
      run: |
        npm run optimize
    
    - name: Run full optimization
      if: ${{ github.event.inputs.optimization_level == 'full' || github.event.inputs.optimization_level == 'aggressive' }}
      run: |
        npm run optimize:full
    
    - name: Run aggressive optimization
      if: ${{ github.event.inputs.optimization_level == 'aggressive' }}
      run: |
        npm run deps:check
        npm run security:audit
        npm run performance:analyze
    
    - name: Run tests with coverage
      run: |
        npm run test:coverage
    
    - name: Performance benchmarking
      run: |
        npm run test:performance
    
    - name: Generate optimization report
      run: |
        node -e "
        const fs = require('fs');
        const report = {
          timestamp: new Date().toISOString(),
          node_version: '${{ matrix.node-version }}',
          optimization_level: '${{ github.event.inputs.optimization_level }}' || 'auto',
          git_sha: '${{ github.sha }}',
          workflow_run: '${{ github.run_id }}'
        };
        fs.writeFileSync('optimization-ci-report.json', JSON.stringify(report, null, 2));
        "
    
    - name: Upload optimization artifacts
      uses: actions/upload-artifact@v3
      with:
        name: optimization-results-node${{ matrix.node-version }}
        path: |
          optimization-report.json
          OPTIMIZATION_REPORT.md
          optimization-ci-report.json
          coverage/
        retention-days: 30
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: optimization
        name: optimization-coverage
    
    - name: Performance regression check
      run: |
        # Compare with previous performance metrics
        if [ -f "previous-performance.json" ]; then
          node -e "
          const fs = require('fs');
          const current = JSON.parse(fs.readFileSync('optimization-report.json', 'utf-8'));
          const previous = JSON.parse(fs.readFileSync('previous-performance.json', 'utf-8'));
          
          // Simple performance regression detection
          if (current.summary.totalOptimizations < previous.summary.totalOptimizations * 0.9) {
            console.log('⚠️ Performance regression detected!');
            process.exit(1);
          }
          console.log('✅ Performance metrics are stable or improved');
          "
        else
          echo "No previous performance data available for comparison"
        fi
    
    - name: Comment PR with optimization results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          if (fs.existsSync('OPTIMIZATION_REPORT.md')) {
            const report = fs.readFileSync('OPTIMIZATION_REPORT.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## 🚀 Optimization Report\n\n${report}\n\n---\n*Auto-generated by optimization workflow*`
            });
          }

  security-scan:
    runs-on: ubuntu-latest
    needs: optimize
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Security audit
      run: |
        npm audit --audit-level high
        npm run security:audit
    
    - name: Dependency vulnerability scan
      uses: actions/dependency-review-action@v3
      if: github.event_name == 'pull_request'
    
    - name: CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        languages: javascript

  deploy-optimizations:
    runs-on: ubuntu-latest
    needs: [optimize, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build optimized version
      run: |
        npm run build:optimized
    
    - name: Store performance metrics
      run: |
        cp optimization-report.json previous-performance.json
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add previous-performance.json
        git commit -m "Update performance baseline [skip ci]" || exit 0
        git push || exit 0
    
    - name: Create optimization summary
      run: |
        echo "## 🎯 Optimization Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "OPTIMIZATION_REPORT.md" ]; then
          cat OPTIMIZATION_REPORT.md >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Notify on optimization completion
      if: always()
      run: |
        echo "Optimization workflow completed for commit ${{ github.sha }}"
        echo "View detailed report in the workflow artifacts"