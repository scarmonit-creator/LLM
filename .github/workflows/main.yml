name: Test Secrets Integration

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-secrets:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Check Event Context
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Ref: ${{ github.ref }}"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR number: ${{ github.event.number }}"
            echo "PR head repo: ${{ github.event.pull_request.head.repo.full_name }}"
            echo "PR base repo: ${{ github.event.pull_request.base.repo.full_name }}"
          fi
      
      - name: Verify SSH Private Key Secret
        run: |
          # Check if secret is available (secrets are not accessible in PRs from forks)
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "‚ö†Ô∏è  Skipping SSH_PRIVATE_KEY verification for external PR"
            echo "Secrets are not accessible in pull requests from forked repositories"
            exit 0
          fi
          
          if [ -z "$SSH_KEY" ]; then
            echo "‚ùå Error: SSH_PRIVATE_KEY secret is not set or not accessible"
            echo "This could happen if:"
            echo "  1. The secret is not configured in repository settings"
            echo "  2. This is a pull request from a fork (secrets not accessible)"
            echo "  3. Repository permissions don't allow secret access"
            exit 1
          fi
          echo "‚úÖ SSH_PRIVATE_KEY secret is properly configured"
          echo "üìä SSH key length: ${#SSH_KEY} characters"
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Verify GPG Private Key Secret
        run: |
          # Check if secret is available (secrets are not accessible in PRs from forks)
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "‚ö†Ô∏è  Skipping GPG_PRIVATE_KEY verification for external PR"
            exit 0
          fi
          
          if [ -z "$GPG_KEY" ]; then
            echo "‚ùå Error: GPG_PRIVATE_KEY secret is not set or not accessible"
            exit 1
          fi
          echo "‚úÖ GPG_PRIVATE_KEY secret is properly configured"
          echo "üìä GPG key length: ${#GPG_KEY} characters"
        env:
          GPG_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      
      - name: Verify GH_TOKEN Secret
        run: |
          # Check if secret is available (secrets are not accessible in PRs from forks)
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "‚ö†Ô∏è  Skipping GH_TOKEN verification for external PR"
            exit 0
          fi
          
          if [ -z "$GH_TOKEN" ]; then
            echo "‚ùå Error: GH_TOKEN secret is not set or not accessible"
            exit 1
          fi
          echo "‚úÖ GH_TOKEN secret is properly configured"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: Alternative Secret Verification (Using GITHUB_TOKEN)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository
        run: |
          echo "üîç Alternative verification using GITHUB_TOKEN for external PR:"
          if [ -n "$GITHUB_TOKEN" ]; then
            echo "‚úÖ GITHUB_TOKEN is available for external PR"
            echo "üìä Token length: ${#GITHUB_TOKEN} characters"
          else
            echo "‚ùå GITHUB_TOKEN is not available"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "===================================="
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "üîí External PR - Repository secrets verification skipped"
            echo "  - SSH_PRIVATE_KEY: ‚ö†Ô∏è  (Not accessible from forks)"
            echo "  - GPG_PRIVATE_KEY: ‚ö†Ô∏è  (Not accessible from forks)"
            echo "  - GH_TOKEN: ‚ö†Ô∏è  (Not accessible from forks)"
            echo "  - GITHUB_TOKEN: ‚úÖ (Available for external PRs)"
          else
            echo "üîì Internal workflow - All repository secrets verified!"
            echo "  - SSH_PRIVATE_KEY: ‚úÖ"
            echo "  - GPG_PRIVATE_KEY: ‚úÖ"
            echo "  - GH_TOKEN: ‚úÖ"
          fi
          echo "===================================="