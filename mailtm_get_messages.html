<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mail.tm Get Messages</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 1rem;
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        background: #f5f5f5;
        padding: 1rem;
        border-radius: 4px;
        max-height: 80vh;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <h1>Mail.tm API Demo: Get Messages</h1>
    <p>This page calls the Mail.tm API to fetch a token and then lists the messages in the inbox. When complete it will automatically download the messages JSON file.</p>
    <pre id="status">Fetching token and messages...</pre>
    <script>
      (async () => {
        const statusEl = document.getElementById('status');
        const credentials = {
          address: 'assistant737396@tiffincrane.com',
          password: 'AssistantDemo123!'
        };
        try {
          // Obtain token for the account
          const tokenRes = await fetch('https://api.mail.tm/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(credentials)
          });
          const tokenJson = await tokenRes.json();
          statusEl.textContent = `Token status: ${tokenRes.status}\nToken response: ${JSON.stringify(tokenJson, null, 2)}`;
          if (!tokenJson.token) {
            throw new Error('Token not obtained');
          }
          // Fetch messages using the token
          const messagesRes = await fetch('https://api.mail.tm/messages', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${tokenJson.token}` }
          });
          const messagesJson = await messagesRes.json();
          statusEl.textContent += `\n\nMessages status: ${messagesRes.status}\nMessages response: ${JSON.stringify(messagesJson, null, 2)}`;
          // Download messages as JSON file
          const blob = new Blob([JSON.stringify(messagesJson, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'mailtm_messages.json';
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        } catch (err) {
          statusEl.textContent += `\n\nError: ${err.message}`;
        }
      })();
    </script>
  </body>
</html>